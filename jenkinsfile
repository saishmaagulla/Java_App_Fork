pipeline{
agent any
stages{
stage('Build'){
steps{

checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/saishmaagulla/Java_App_Fork.git/']]])
sh '''cd SpringMVCSecurityXML
mvn clean install -D build_number=${BUILD_NUMBER}'''

}
}
stage('Backup'){
    steps{
        sh '''
        echo "deploying to artifactory"
       curl -u admin:password -T /var/lib/jenkins/.m2/repository/org/o7planning/SpringMVCSecurityXML/*-${BUILD_NUMBER}/*-${BUILD_NUMBER}.war "http://35.226.89.105:8081/artifactory/saishma_maven1/"
       echo "deployed"
       echo "Downloading the  artifact"
       cd /var/lib/jenkins/.m2/repository/org/o7planning/SpringMVCSecurityXML/*-${BUILD_NUMBER}
       var=$(ls -ltrp | grep .war  | tail -1 | awk '{print $9}')
       echo $var
       cd /var/lib/jenkins/workspace/Java_Declarative_Env/SpringMVCSecurityXML/target
       wget "http://35.226.89.105:8081/artifactory/saishma_maven1/$var"
       mv $var latest.war
       ls
       '''
    }
}
stage('Deploy'){
    steps{
        sh '''cp /var/lib/jenkins/workspace/Java_Declarative_Env/SpringMVCSecurityXML/target/latest.war /var/lib/tomcat8/webapps '''
    }
}
}
}
